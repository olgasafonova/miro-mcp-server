name: Miro API Tracking

on:
  schedule:
    # Every Monday at 09:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Manual trigger

permissions:
  issues: write
  contents: read

jobs:
  check-api-changes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download latest Miro OpenAPI spec
        run: |
          curl -fsSL \
            "https://raw.githubusercontent.com/miroapp/api-clients/main/packages/generator/spec.json" \
            -o /tmp/miro-spec-latest.json

      - name: Run spec diff
        id: diff
        run: |
          set +e
          python3 api-tracking/diff-spec.py \
            api-tracking/spec-baseline.json \
            /tmp/miro-spec-latest.json > /tmp/diff-report.md
          echo "has_changes=$?" >> "$GITHUB_OUTPUT"

      - name: Create issue if changes found
        if: steps.diff.outputs.has_changes == '1'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPORT=$(cat /tmp/diff-report.md)
          TITLE="Miro API changes detected ($(date +%Y-%m-%d))"

          BODY=$(cat <<'DELIM'
          ## Automated API Tracking

          The weekly Miro OpenAPI spec check found changes since our last baseline.

          DELIM
          )
          BODY="${BODY}

          ${REPORT}

          ---

          **Next steps:**
          1. Review changes above
          2. Implement new endpoints or update existing ones
          3. Update baseline: \`cp /tmp/miro-spec-latest.json api-tracking/spec-baseline.json\`
          4. Close this issue

          _Generated by [api-tracking workflow](../../.github/workflows/api-tracking.yml)_"

          gh issue create \
            --title "$TITLE" \
            --body "$BODY" \
            --label "api-tracking"

      - name: Summary
        run: |
          if [ "${{ steps.diff.outputs.has_changes }}" = "1" ]; then
            echo "### Changes detected" >> "$GITHUB_STEP_SUMMARY"
            cat /tmp/diff-report.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### No changes" >> "$GITHUB_STEP_SUMMARY"
            echo "Miro API spec matches our baseline." >> "$GITHUB_STEP_SUMMARY"
          fi

name: Publish to MCP Registry

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    name: Publish to MCP Registry
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Wait for Docker image
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          IMAGE="ghcr.io/olgasafonova/miro-mcp-server:${VERSION}"
          echo "Waiting for Docker image: $IMAGE"

          for i in {1..30}; do
            if docker manifest inspect "$IMAGE" > /dev/null 2>&1; then
              echo "Docker image available!"
              exit 0
            fi
            echo "Attempt $i/30: Image not ready, waiting 30s..."
            sleep 30
          done

          echo "Error: Docker image not available after 15 minutes"
          exit 1

      - name: Wait for release binaries
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Waiting for release binaries..."

          for i in {1..20}; do
            COUNT=$(gh release view "v${VERSION}" --json assets --jq '.assets | length')
            if [ "$COUNT" -ge 5 ]; then
              echo "Release has $COUNT assets, ready!"
              exit 0
            fi
            echo "Attempt $i/20: Only $COUNT assets, waiting 15s..."
            sleep 15
          done

          echo "Error: Release binaries not ready after 5 minutes"
          exit 1

      - name: Download release assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p assets
          gh release download "v${VERSION}" --pattern "miro-mcp-server-*" --dir assets || true
          ls -la assets/

      - name: Calculate SHA256 hashes
        id: hashes
        run: |
          cd assets
          for f in *; do
            # Extract platform suffix from filename (e.g., darwin-arm64, linux-amd64)
            name=$(echo "$f" | sed 's/miro-mcp-server-//' | sed 's/\.exe$//')
            # Replace hyphens with underscores for valid output names
            output_name=$(echo "$name" | tr '-' '_')
            hash=$(sha256sum "$f" | cut -d' ' -f1)
            echo "${output_name}_sha256=${hash}" >> $GITHUB_OUTPUT
            echo "$f: $hash"
          done

      - name: Update server.json
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO="olgasafonova/miro-mcp-server"
          BASE_URL="https://github.com/${REPO}/releases/download/v${VERSION}"

          # Get env vars from current server.json
          ENV_VARS=$(jq '.packages[0].environmentVariables' server.json)

          # Build new server.json with OCI and all MCPB packages
          jq --arg v "$VERSION" \
             --arg docker_img "ghcr.io/${REPO}:${VERSION}" \
             --arg base_url "$BASE_URL" \
             --argjson env_vars "$ENV_VARS" \
             --arg darwin_arm64_sha "${{ steps.hashes.outputs.darwin_arm64_sha256 }}" \
             --arg darwin_amd64_sha "${{ steps.hashes.outputs.darwin_amd64_sha256 }}" \
             --arg linux_amd64_sha "${{ steps.hashes.outputs.linux_amd64_sha256 }}" \
             --arg linux_arm64_sha "${{ steps.hashes.outputs.linux_arm64_sha256 }}" \
             --arg windows_amd64_sha "${{ steps.hashes.outputs.windows_amd64_sha256 }}" \
             '
             .version = $v |
             .packages = [
               {
                 "registryType": "oci",
                 "identifier": $docker_img,
                 "transport": {"type": "stdio"},
                 "environmentVariables": $env_vars
               },
               {
                 "registryType": "mcpb",
                 "identifier": ($base_url + "/miro-mcp-server-darwin-arm64"),
                 "fileSha256": $darwin_arm64_sha,
                 "runtime": {"type": "native", "platforms": ["darwin-arm64"]},
                 "transport": {"type": "stdio"},
                 "environmentVariables": $env_vars
               },
               {
                 "registryType": "mcpb",
                 "identifier": ($base_url + "/miro-mcp-server-darwin-amd64"),
                 "fileSha256": $darwin_amd64_sha,
                 "runtime": {"type": "native", "platforms": ["darwin-amd64"]},
                 "transport": {"type": "stdio"},
                 "environmentVariables": $env_vars
               },
               {
                 "registryType": "mcpb",
                 "identifier": ($base_url + "/miro-mcp-server-linux-amd64"),
                 "fileSha256": $linux_amd64_sha,
                 "runtime": {"type": "native", "platforms": ["linux-amd64"]},
                 "transport": {"type": "stdio"},
                 "environmentVariables": $env_vars
               },
               {
                 "registryType": "mcpb",
                 "identifier": ($base_url + "/miro-mcp-server-linux-arm64"),
                 "fileSha256": $linux_arm64_sha,
                 "runtime": {"type": "native", "platforms": ["linux-arm64"]},
                 "transport": {"type": "stdio"},
                 "environmentVariables": $env_vars
               },
               {
                 "registryType": "mcpb",
                 "identifier": ($base_url + "/miro-mcp-server-windows-amd64.exe"),
                 "fileSha256": $windows_amd64_sha,
                 "runtime": {"type": "native", "platforms": ["windows-amd64"]},
                 "transport": {"type": "stdio"},
                 "environmentVariables": $env_vars
               }
             ]
             ' server.json > server.json.tmp
          mv server.json.tmp server.json
          cat server.json

      - name: Install mcp-publisher
        run: |
          curl -sL "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_linux_amd64.tar.gz" | tar xz
          chmod +x mcp-publisher

      - name: Authenticate with MCP Registry
        run: ./mcp-publisher login github-oidc

      - name: Publish to MCP Registry
        run: ./mcp-publisher publish
